<div class="task-input-form">
  <div class="title-row">
    <mat-form-field appearance="outline" class="project-field">
      <mat-label for="project-name-input">プロジェクト名（タグ）</mat-label>
      <input matInput id="project-name-input" [(ngModel)]="tagNames" placeholder="例：プロジェクト名" (ngModelChange)="onTagChange()" />
    </mat-form-field>
    
    <mat-form-field appearance="outline" class="task-name-field">
      <mat-label for="task-name-input">タスク名</mat-label>
      <input matInput id="task-name-input" [(ngModel)]="title" placeholder="タスク名" />
    </mat-form-field>
  </div>

  <!-- 担当者選択欄 -->
  <div class="assignee-section" *ngIf="showAssigneeSection">
    <div class="assignee-header">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>担当者を選択</mat-label>
        <mat-select [(ngModel)]="selectedAssignedUsers" multiple (selectionChange)="onAssignedUserChange()">
          <mat-option *ngFor="let user of assignedUsers" [value]="user.email">
            {{ user.displayName }} ({{ user.email }})
          </mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-button color="primary" (click)="clearAllAssignees()" *ngIf="selectedAssignedUsers.length > 0">
        <mat-icon>clear_all</mat-icon>
        すべて解除
      </button>
    </div>

    <!-- 選択された担当者を表示 -->
    <div class="selected-assignees" *ngIf="selectedAssignedUsers.length > 0">
      <div class="selected-assignee-badge" *ngFor="let email of selectedAssignedUsers">
        <mat-icon>person</mat-icon>
        <div class="assignee-info">
          <span class="assignee-name">{{ getSelectedAssigneeDisplayName(email) }}</span>
          <span class="assignee-email">{{ email }}</span>
        </div>
      </div>
    </div>
  </div>

  <mat-form-field appearance="outline" class="full-width">
    <mat-label for="task-content-input">内容を追加</mat-label>
    <textarea matInput id="task-content-input" [(ngModel)]="content" placeholder="内容を追加" rows="2"></textarea>
  </mat-form-field>

  <div class="image-upload-section">
    <div class="image-preview" *ngIf="imagePreview || imageUrl">
      <img [src]="imagePreview || imageUrl" alt="タスク画像" />
      <button mat-icon-button class="remove-image" (click)="removeImage()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="image-upload-button">
      <input type="file" 
             accept="image/*" 
             (change)="onImageSelected($event)" 
             style="display: none" 
             #fileInput>
      <button mat-stroked-button 
              (click)="fileInput.click()"
              [disabled]="!!imagePreview || !!imageUrl">
        <mat-icon>add_photo_alternate</mat-icon>
        画像を添付
      </button>
    </div>
  </div>

  <div class="status-buttons">
    <button mat-button [class.active]="status === '未着手'" (click)="setStatus('未着手')">
      <mat-icon>radio_button_unchecked</mat-icon>
      未着手
    </button>
    <button mat-button [class.active]="status === '進行中'" (click)="setStatus('進行中')">
      <mat-icon>play_circle_outline</mat-icon>
      進行中
    </button>
    <button mat-button [class.active]="status === '完了'" (click)="setStatus('完了')">
      <mat-icon>check_circle_outline</mat-icon>
      完了
    </button>
  </div>

  <div class="date-time-priority-row">
    <div class="date-fields">
      <div class="start-date-priority-row">
    <div class="date-field">
      <mat-form-field appearance="outline">
        <mat-label for="start-date-input">開始日</mat-label>
        <input matInput id="start-date-input" [matDatepicker]="startPicker" [(ngModel)]="startDate">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>
    </div>

        <mat-form-field appearance="outline" class="priority-field">
          <mat-label for="priority-select">優先度</mat-label>
          <mat-select id="priority-select" [(ngModel)]="priority">
            <mat-option value="low">低</mat-option>
            <mat-option value="medium">中</mat-option>
            <mat-option value="high">高</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="due-date-time-row">
    <div class="date-field">
      <mat-form-field appearance="outline">
        <mat-label for="due-date-input">締切日</mat-label>
        <input matInput id="due-date-input" [matDatepicker]="duePicker" [(ngModel)]="dueDate">
        <mat-datepicker-toggle matSuffix [for]="duePicker"></mat-datepicker-toggle>
        <mat-datepicker #duePicker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="time-select">
      <mat-form-field appearance="outline">
        <mat-label for="hour-select">時</mat-label>
        <mat-select id="hour-select" [(ngModel)]="selectedHour">
          <mat-option *ngFor="let hour of hours" [value]="hour">
            {{hour}}時
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label for="minute-select">分</mat-label>
        <mat-select id="minute-select" [(ngModel)]="selectedMinute">
          <mat-option *ngFor="let minute of minutes" [value]="minute">
            {{minute}}分
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
      </div>
    </div>
  </div>

  <div class="location-section">
    <h3>位置情報</h3>
    <app-location-picker
      [location]="location"
      (locationChange)="onLocationChange($event)"
      class="full-width">
    </app-location-picker>
  </div>

  <div class="task-actions">
    <button mat-raised-button color="primary" (click)="saveTask()">保存</button>
    <button mat-button (click)="cancelTask()">キャンセル</button>
  </div>
</div>
